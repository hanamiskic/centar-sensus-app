<section class="profil-wrapper" *ngIf="user$ | async as user">
  <!-- PROFIL: Header s osnovnim informacijama korisnika -->
  <header class="profil-header">
    <div class="profil-info">
      <h1 class="ime-prezime">{{ user.fullName }}</h1>
      <p class="email">{{ user.email }}</p>
    </div>
  </header>

  <!--  MOJI DOGAĐAJI  -->
  <section class="moji-dogadaji">
    <h2 class="sekcija-naslov">Moji događaji</h2>

    <!-- Aktivni -->
    <ng-container
      *ngTemplateOutlet="eventsBlock; context: {
        title: 'Aktivni događaji',
        list: activeMyEvents,
        emptyMsg: 'Nema aktivnih prijava.'
      }">
    </ng-container>

    <!-- Završeni -->
    <ng-container
      *ngTemplateOutlet="eventsBlock; context: {
        title: 'Završeni događaji',
        list: finishedMyEvents,
        emptyMsg: 'Nema završenih prijava.'
      }">
    </ng-container>

    <!-- Zajednički template za listanje događaja -->
    <ng-template #eventsBlock let-title="title" let-list="list" let-emptyMsg="emptyMsg">
      <section class="events-section">
        <h3 class="sekcija-naslov sub">{{ title }}</h3>

        <!-- Status učitavanja (aria-live za pristupačnost) -->
        <div *ngIf="loadingMyEvents" class="status loading" role="status" aria-live="polite">Učitavanje…</div>

        <!-- Sadržaj ili prazno stanje -->
        <ng-container *ngIf="!loadingMyEvents && list?.length; else noItems">
          <div class="events-grid">
            <app-event-card
              *ngFor="let e of list; trackBy: trackByEventId"
              [event]="e"
              [isAdmin]="false"
              from="profil">
            </app-event-card>
          </div>
        </ng-container>

        <ng-template #noItems>
          <p class="status empty" *ngIf="!loadingMyEvents">{{ emptyMsg }}</p>
        </ng-template>
      </section>
    </ng-template>
  </section>

  <!--  ADMIN: KORISNICI -->
  <section *ngIf="isAdmin" class="admin-users">
    <h2 class="sekcija-naslov">Korisnici</h2>

    <div *ngIf="loadingUsers" class="status loading" role="status" aria-live="polite">Učitavanje…</div>

    <div class="table-wrap" *ngIf="!loadingUsers">
      <table class="users-table">
        <thead>
          <tr>
            <th scope="col">Email</th>
            <th scope="col">Ime</th>
            <th scope="col">Prezime</th>
            <th scope="col">Član</th>
            <th scope="col">Telefon</th>
            <th scope="col">Registriran</th>
            <th scope="col" class="actions-col">Akcije</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let u of pagedUsers; trackBy: trackByUid">
            <td>{{ u.email }}</td>
            <td>{{ u.firstName }}</td>
            <td>{{ u.lastName }}</td>
            <td>{{ u.membership || '—' }}</td>
            <td>{{ u.phone || '—' }}</td>
            <td>{{ formatDate(u.createdAt) }}</td>
            <td class="actions-col">
              <button
                type="button"
                class="btn-delete"
                (click)="removeUser(u.uid)"
                [disabled]="u.uid === currentUid"
                [title]="u.uid === currentUid ? 'Ne možeš obrisati vlastiti račun' : 'Obriši korisnika'">
                🗑️ Obriši
              </button>
            </td>
          </tr>

          <!-- Prazno stanje tablice -->
          <tr *ngIf="users.length === 0">
            <td colspan="7" class="empty">Nema korisnika.</td>
          </tr>
        </tbody>
      </table>

      <!-- Paginacija -->
      <div class="pagination" *ngIf="users.length">
        <div class="rows-per-page">
          <label for="rpp">Redova:</label>
          <select id="rpp" (change)="changePageSize($any($event.target).value)">
            <option [selected]="pageSize === 10" value="10">10</option>
            <option [selected]="pageSize === 20" value="20">20</option>
            <option [selected]="pageSize === 50" value="50">50</option>
            <option [selected]="pageSize === 100" value="100">100</option>
          </select>
        </div>

        <div class="page-info">Prikaz {{ showingFrom }}–{{ showingTo }} od {{ users.length }}</div>

        <div class="pager-buttons">
          <button type="button" (click)="prevPage()" [disabled]="pageIndex === 0">« Prethodna</button>
          <span>Stranica {{ pageIndex + 1 }} / {{ pageCount }}</span>
          <button type="button" (click)="nextPage()" [disabled]="pageIndex + 1 >= pageCount">Sljedeća »</button>
        </div>
      </div>
    </div>
  </section>
</section>
